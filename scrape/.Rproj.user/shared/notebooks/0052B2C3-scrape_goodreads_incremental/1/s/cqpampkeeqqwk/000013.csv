"0",""
"0","need_key <- !""review_id"" %in% names(old) || all(is.na(old$review_id))"
"0",""
"0","if (need_key) {"
"0","  message(""Old file lacks review_id. Doing a quick shelf scrape to rebuild keys..."")"
"0","  quick <- scrape_shelf_table(""read"", max_pages = 50, sleep_sec = 1)"
"0","  quick_keys <- quick %>%"
"0","    transmute("
"0","      title,"
"0","      book_url,"
"0","      view,"
"0","      review_id = extract_review_id(view)"
"0","    )"
"0","  # Join using (book_url, title) as a conservative heuristic key."
"0","  # Adjust if you keep a better unique key."
"0","  old <- old %>%"
"0","    left_join(quick_keys, by = c(""book_url"", ""title"")) "
"0","  # %>%"
"0","  #   mutate(review_id = coalesce(review_id.x, review_id.y)) %>%"
"0","  #   select(-review_id.x, -review_id.y)"
"0","}"
"2","Old file lacks review_id. Doing a quick shelf scrape to rebuild keys...
"
"2",".. [read p.1] selector='tr.bookalike.review' rows=100
"
"2",".. [read p.2] selector='tr.bookalike.review' rows=100
"
"2",".. [read p.3] selector='tr.bookalike.review' rows=61
"
"0","if (!""review_id"" %in% names(old) || all(is.na(old$review_id))) {"
"0","  stop(""Could not infer review_id for existing rows. "","
"0","       ""Consider re-exporting master with `view`/`review_id`."")"
"0","}"
"0",""
