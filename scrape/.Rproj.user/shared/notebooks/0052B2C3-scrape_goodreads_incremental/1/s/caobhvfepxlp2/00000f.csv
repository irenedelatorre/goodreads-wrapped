"0",""
"0","old_keys <- old %>% filter(!is.na(review_id)) %>% pull(review_id)"
"0",""
"0","new_ids <- setdiff(current$review_id, old_keys)"
"0","new_rows <- current %>% filter(review_id %in% new_ids)"
"0",""
"0","# Detect changed rows: compare a few columns (date_* , my_rating, shelves)"
"0","cols_to_compare <- intersect("
"0","  c(""date_started"", ""date_finished"", ""my_rating"", ""shelves""),"
"0","  intersect(names(old), names(current))"
"0",")"
"0",""
"0","# Wide join current vs old on review_id"
"0","comp_tbl <- current %>%"
"0","  select(review_id, all_of(cols_to_compare)) %>%"
"0","  left_join("
"0","    old %>% select(review_id, all_of(cols_to_compare)),"
"0","    by = ""review_id"","
"0","    suffix = c("""", ""_old"")"
"0","  )"
"0",""
"0","# For each row, mark TRUE if ANY of the comparison columns changed"
"0","changed_flag <- rep(FALSE, nrow(comp_tbl))"
"0",""
"0","for (col in cols_to_compare) {"
"0","  new_col <- comp_tbl[[col]]"
"0","  old_col <- comp_tbl[[paste0(col, ""_old"")]]"
"0","  "
"0","  # changed if (not both NA) AND (values differ)"
"0","  changed_here <- !(is.na(new_col) & is.na(old_col)) & (new_col != old_col)"
"0","  changed_flag <- changed_flag | (changed_here %in% TRUE)"
"0","}"
"0",""
"0","changed_ids <- comp_tbl$review_id[changed_flag]"
"0",""
"0","changed_rows <- current %>%"
"0","  filter(review_id %in% changed_ids)"
"0",""
"0","# Books likely in progress (no finish date)"
"0","in_progress <- current %>%"
"0","  filter("
"0","    is.na(date_finished),"
"0","    as.Date(date_added, ""%b %d 20%y"") < as.Date(""Jan 01, 2020"", ""%b %d 20%y"")"
"0","    )"
"0",""
"0","to_refresh <- bind_rows(changed_rows, in_progress) %>%"
"0","  distinct(review_id, .keep_all = TRUE)"
"0",""
"0","targets <- bind_rows(new_rows, to_refresh) %>%"
"0","  distinct(review_id, .keep_all = TRUE)"
"0",""
"0","message(sprintf(""New: %d | Refresh: %d | Total targets: %d"","
"0","                nrow(new_rows), nrow(to_refresh), nrow(targets)))"
"2","New: 3 | Refresh: 0 | Total targets: 3
"
